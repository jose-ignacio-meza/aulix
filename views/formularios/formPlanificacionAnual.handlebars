<!-- Estilo -->
<style>
  /* Contenedor general del formulario */
  form {
    max-width: 1800px;
    margin: 0 auto;
    font-family: Arial, sans-serif;
    background: #fdfdfd;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  form h2 {
    margin-bottom: 1rem;
    color: #333;
  }

  label {
    font-weight: bold;
    margin-top: 0.8rem;
    display: block;
    color: #555;
  }

  input[type="text"],
  select {
    width: 100%;
    padding: 0.5rem;
    margin-top: 0.3rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  /* Efectos de focus */
  input:focus,
  select:focus {
    border-color: #009aae;
    box-shadow: 0 0 4px rgba(0,154,174,0.4);
    outline: none;
  }

  /* Validaciones visuales */
  .is-valid {
    border-color: #28a745 !important;
    background-color: #eaffea;
  }
  .is-invalid {
    border-color: #dc3545 !important;
    background-color: #ffeaea;
  }

  /* Bloques de cursos */
  .curso-block {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }
  .curso-block h3 {
    margin-top: 0;
    color: #444;
  }
  .curso-block h4 {
    margin-bottom: 0.3rem;
    margin-top: 1rem;
    font-size: 15px;
    color: #555;
  }

  /* Botones */
  .btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: #009aae;
    color: #fff;
    font-size: 14px;
    transition: background 0.3s ease;
  }
  .btn:hover {
    background: #007d89;
  }

  /* Bot√≥n verde espec√≠fico */
  .btn.save {
    background: green;
  }
  .btn.save:hover {
    background: darkgreen;
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3; /* borde gris */
    border-top: 5px solid #009aae; /* borde superior color */
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
<!-- Fin Estilos -->

<!-- Formulario -->
  <form method="POST" action="/formularios/enviar-planificacion-anual">
    <h2 style="text-align:center;">Formulario: Planificaci√≥n Anual</h2>

    <!-- Datos iniciales -->
    <label for="titulo">Titulo</label>
    <input type="text" id="titulo" name="titulo" value="Planificacion Anual" readonly onPaste="false">

    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" name="nombre" value="{{datos.usuario.datosPersonales.nombre}} ">

    <label for="apellido">Apellido</label>
    <input type="text" id="apellido" name="apellido" value="{{datos.usuario.datosPersonales.apellido}}">

    <label for="dni">DNI</label>
    <input type="text" id="dni" name="dni" value="{{datos.usuario.datosPersonales.dni}}">

    <label for="anio">A√±o Lectivo</label>
    <input type="text" id="anio" name="anio" value="{{datos.respuestas.anio}}" placeholder="Ej: 2025">
    

    <label for="modalidad">Modalidad</label>
    <select id="modalidad" name="modalidad">
      <option value="0" selected disabled>Seleccione una Modalidad</option>
      {{#each modalidades}}
          <option value="{{this._id}}">{{this.descripcion}}</option>
      {{/each}}
    </select>

    <label for="institucion">Instituci√≥n</label>
    <select id="institucion" name="institucion">
      <option value="">Seleccione instituci√≥n</option>
      {{#each instituciones}}
        {{#if (eq this._id ../datos.usuario.institucion)}}
          <option value="{{_id}}" selected>{{nombre}}</option>
        {{else}}
          <option value="{{_id}}">{{nombre}}</option>
        {{/if}}
      {{/each}}
    </select>

    <!-- Cursos din√°micos -->
    <div id="cursos-container"></div>

    <button type="submit" class="btn" style="margin-top:1rem;background:green;">Guardar y Continuar</button>
  </form>

<!-- Fin Formulario -->

<!-- Loader con spinner -->
<div id="loader" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.8);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
">
  <div class="spinner"></div>
  <div style="margin-top: 10px; font-size: 1.2rem; color: #009aae;">
    Cargando contenidos...
  </div>
</div>
<!-- Fin Loader con spinner -->

<!--<pre>{{datosDebug}}</pre> datos puros para analizar estructura-->

<script>
  //-------Funciones del loader------------------
  function mostrarLoader() {
    document.getElementById("loader").style.display = "flex";
  }

  function ocultarLoader() {
    document.getElementById("loader").style.display = "none";
  }
  //-------Fin funciones del loader-------------


  // Meses por a√±o
  const mesesA√±o = ["Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre"];

  let cursoIndex = 0;

  // Datos del backend
  const contenidos = {{{json contenidos}}};
  const perspectivas = {{{json perspectivas}}};
  const propositos = {{{json propositos}}};
  const criterios = {{{json criterios}}};
  const datosInstituciones = {{{json instituciones}}};

  // üîπ Al cargar la p√°gina, agregar curso preseleccionado si existe
  document.addEventListener('DOMContentLoaded', () => {
    const institucionId = "{{datos.usuario.institucion}}";
    const cursoId = "{{datos.usuario.curso}}" || null;

    if (institucionId && cursoId) {
      const institucion = datosInstituciones.find(i => i._id.toString() === institucionId);
      if (institucion) {
        const curso = institucion.cursos.find(c => c._id.toString() === cursoId);
        if (curso) {
          agregarCurso(cursoIndex++, curso._id, curso.nombre, institucionId);
        }
      }
    }
    ocultarLoader();
  });

  const cursosContainer = document.getElementById('cursos-container');

  // Instituci√≥n Seleccionada
  const selectInstitucion = document.getElementById('institucion');
  let institucionActual = selectInstitucion.value; // valor de la opci√≥n seleccionada
  console.log("Instituci√≥n actual:", institucionActual);
  
  let cursosDisponiblesPorInstitucion = {}; // { idInstitucion: [ {id, nombre}, ... ] }

  // Inicializar al cargar la p√°gina
  datosInstituciones.forEach(inst => {
    cursosDisponiblesPorInstitucion[inst._id] = inst.cursos.map(c => ({
      id: c._id,
      area: c.area._id,
      nombre: c.nombre,
      seleccionado: false
    }));
  });

  /**
   * Crear y manejar el select de cursos seg√∫n la instituci√≥n seleccionada
   */
  const selectCursoLabel = document.createElement('label');
  selectCursoLabel.innerText = 'Curso';
  selectCursoLabel.htmlFor = 'curso';

  const selectCurso = document.createElement('select');
  selectCurso.id = 'curso';
  selectCurso.name = 'curso';
  selectCurso.innerHTML = '<option value="">Seleccione un curso</option>';
  selectCurso.style.marginTop = '1rem';

  // Insertar el label y el select de cursos debajo del select de instituciones
  selectInstitucion.parentNode.insertBefore(selectCursoLabel, selectInstitucion.nextSibling);
  selectInstitucion.parentNode.insertBefore(selectCurso, selectCursoLabel.nextSibling);

  // Funci√≥n para poblar cursos seg√∫n la instituci√≥n seleccionada
  function poblarCursosPorInstitucion(idInstitucion, cursoSeleccionado = "") {
    selectCurso.innerHTML = '<option value="">Seleccione un curso</option>';
    if (idInstitucion && cursosDisponiblesPorInstitucion[idInstitucion]) {
      cursosDisponiblesPorInstitucion[idInstitucion].forEach(curso => {
        const selected = cursoSeleccionado && curso.id === cursoSeleccionado ? 'selected' : '';
        selectCurso.innerHTML += `<option value="${curso.id}" ${selected}>${curso.nombre}</option>`;
      });
    }
  }

  // Al cambiar la instituci√≥n, actualizar cursos
  selectInstitucion.addEventListener('change', function () {
    const idInstitucion = this.value;
    poblarCursosPorInstitucion(idInstitucion);
    // Limpiar cursos din√°micos si cambia la instituci√≥n
    cursosContainer.innerHTML = '';
  });

  // Si ya hay una instituci√≥n seleccionada al cargar, poblar cursos
  if (selectInstitucion.value) {
    poblarCursosPorInstitucion(selectInstitucion.value, "{{datos.usuario.curso}}");
  }

  // Al seleccionar un curso, agregar el bloque din√°mico
  selectCurso.addEventListener('change', function () {
    cursosContainer.innerHTML = '';
    if (this.value && selectInstitucion.value) {
      const cursoObj = cursosDisponiblesPorInstitucion[selectInstitucion.value].find(c => c.id === this.value);
      if (cursoObj) {
        agregarCurso(cursoIndex++, cursoObj.id, cursoObj.nombre, selectInstitucion.value);
      }
    }
  });
 

  // Funci√≥n para agregar un bloque de curso din√°mico
  function agregarCurso(index='', idCurso = null, nombreCurso = "", idInstitucion = null) {
    const cursoDiv = document.createElement('div');
    
    cursoDiv.classList.add('curso-block');
    cursoDiv.style.border = "1px solid #ccc";
    cursoDiv.style.padding = "1rem";
    cursoDiv.style.marginTop = "1rem";
    cursoDiv.style.borderRadius = "8px";

    if (!idInstitucion) return;

    const optionsHTML = cursosDisponiblesPorInstitucion[idInstitucion].map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
    console.log("optionsHTML:", optionsHTML);
    cursoDiv.innerHTML = `
      <label>Curso/√Årea</label>
      <select name="cursos[${index}][nombre]" class="curso-select">
        ${nombreCurso ? `<option value="${idCurso}" selected>${nombreCurso}</option>` : '<option value="">-- Seleccionar --</option>'}
        ${optionsHTML}
      </select>

      <input type="hidden" value="1" name="cursos[${index}][trimestre]" class="trimestre-select" data-index="${index}">
      <div class="meses-container" id="meses-${index}"></div>
    `;
    console.log("cursoDiv:", cursoDiv);
    cursosContainer.appendChild(cursoDiv);

    // Seleccionamos el curso si ya lo trae
    const cursoSelect = cursoDiv.querySelector('.curso-select');

    const mesesDiv = document.getElementById(`meses-${index}`);
    mesesDiv.innerHTML = ""; // limpiar

    mostrarLoader();

    try {
      //Inicio el html que se va a insertar.
      let htmlCompleto = "";
      
      // 1Ô∏è‚É£ Botones toggle de componentes
      let botonesComponentesHTML = `
        <div class="btn-group mb-3" role="group">
          <button type="button" class="comp-toggle btn btn-outline-primary" data-componente="titulo" data-activo="false">T√≠tulo</button>
          <button type="button" class="comp-toggle btn btn-outline-primary" data-componente="modalidad" data-activo="false">Modalidad</button>
          <button type="button" class="comp-toggle btn btn-outline-primary" data-componente="contenido" data-activo="false">Contenido</button>
          <button type="button" class="comp-toggle btn btn-outline-primary" data-componente="perspectivas" data-activo="false">Perspectivas</button>
          <button type="button" class="comp-toggle btn btn-outline-primary" data-componente="propositos" data-activo="false">Propositos</button>
          <button type="button" class="comp-toggle btn btn-outline-primary" data-componente="observaciones" data-activo="false">Observaciones</button>
          <button type="button" class="comp-toggle btn btn-outline-primary" data-componente="criterios" data-activo="false">Criterios</button>
        </div>
        <div class="componentes-container" id="meses-${index}"></div>
      `;

      cursoDiv.innerHTML = botonesComponentesHTML;

      // 2Ô∏è‚É£ Inicializar bloques de meses ocultos
      const mesesDiv = cursoDiv.querySelector(`#meses-${index}`);
      mesesDiv.innerHTML = ""; // limpiar

      for (let mesIndex = 0; mesIndex < mesesA√±o.length; mesIndex++) {
        const mes = mesesA√±o[mesIndex];
        //console.log('curso seleccionado',cursoSelect.value);
        //console.log('aca busco',datosInstituciones);
        
        // 1. Buscar la instituci√≥n que tenga el curso con ese id
        const institucionMatch = datosInstituciones.find(inst => 
          inst.cursos.some(curso => curso._id === cursoSelect.value)
        );

        // 2. Dentro de esa instituci√≥n, buscar el curso espec√≠fico
        const cursoMatch = institucionMatch?.cursos.find(curso => curso._id === cursoSelect.value);

        // 3. Sacar el id del √°rea
        const idAreaCursoSelected = cursoMatch?.area?._id;
        //console.log('area de instituciones:', idAreaCursoSelected);
        //console.log('id del area:', idAreaCursoSelected);
  
        htmlCompleto += `<b><h3>${mes}</h3></b>
          <input type="hidden" name="cursos[${index}][meses][${mesIndex}][mes]" value="${mes}">`;

        // T√≠tulo
        htmlCompleto += `
          <div class="componente" data-componente="titulo" style="display:none">
            <label>T√≠tulo</label>
            <input type="text" name="cursos[${index}][meses][${mesIndex}][titulo]" style="width:100%;">
          </div>
        `;
        
        // ‚úÖ Nuevo bloque: agrupa contenidos por √°rea y arma tabs
        
        // Agrupar contenidos por √°rea
        const contenidosPorArea = {};
        contenidos.forEach(c => {
          const areaId = c.area._id;
          if (!contenidosPorArea[areaId]) {
            contenidosPorArea[areaId] = { nombre: c.area.nombre, contenidos: [] };
          }
          contenidosPorArea[areaId].contenidos.push(c);
        });

        // Generar tabs (Bootstrap)
        htmlCompleto += `
          <div class="componente" data-componente="contenido" style="display:none">
          <span>Seleccione un contenido</span>
          <ul class="nav nav-tabs" id="tabs-area-${index}-${mesIndex}" role="tablist">
            ${Object.entries(contenidosPorArea).map(([areaId, area]) => `
              <li class="nav-item" role="presentation">
                <button class="nav-link ${areaId === idAreaCursoSelected ? "active" : ""}"
                        id="tab-${index}-${mesIndex}-${areaId}"
                        data-bs-toggle="tab"
                        data-bs-target="#contenido-${index}-${mesIndex}-${areaId}"
                        type="button" role="tab">
                  ${area.nombre}
                </button>
              </li>
            `).join("")}
          </ul>
        `;

        // Generar contenido de cada tab
        htmlCompleto += `
          <div class="tab-content" id="tabs-content-${index}-${mesIndex}">
            ${Object.entries(contenidosPorArea).map(([areaId, area]) => `
              <div class="tab-pane fade ${areaId === idAreaCursoSelected ? "show active" : ""}"
                  id="contenido-${index}-${mesIndex}-${areaId}"
                  role="tabpanel">

                ${area.contenidos.map((cont, contIndex) => `
                  <details class="contenido-block">
                    <summary><strong>${cont.titulo}</strong></summary>
                    <div class="items-list" style="margin-top:0.5rem;">
                      ${cont.items.map((item, itemIndex) => `
                        <div class="d-flex align-items-center">
                          <input style="margin-right:6px; height: fit-content;" type="checkbox"
                            name="cursos[${index}][meses][${mesIndex}][contenidos][${contIndex}][items][]"
                            value="${item}"
                            id="curso-${index}-mes-${mesIndex}-cont-${contIndex}-item-${itemIndex}">
                          <label class="my-1"
                            for="curso-${index}-mes-${mesIndex}-cont-${contIndex}-item-${itemIndex}">
                            ${item}
                          </label>
                        </div>
                      `).join('')}
                      <input type="hidden" name="cursos[${index}][meses][${mesIndex}][contenidos][${contIndex}][_id]" value="${cont._id}">
                      <input type="hidden" name="cursos[${index}][meses][${mesIndex}][contenidos][${contIndex}][titulo]" value="${cont.titulo}">
                    </div>
                  </details>
                `).join("")}
              </div>
            `).join("")}
          </div>
        </div><!--Cierre del div de data-componente="contenido"-->`;

        // Perspectivas
        htmlCompleto += `
          <div class="componente" data-componente="perspectivas" style="display:none">
          <label>Perspectivas</label>
          <select name="cursos[${index}][meses][${mesIndex}][perspectivas][]" multiple>
            ${perspectivas.map(p => `<option value="${p._id}">${p.descripcion}</option>`).join('')}
          </select>
          </div>`;

        // Criterios
        htmlCompleto += `
          <div class="componente" data-componente="criterios" style="display:none"> 
          <label>Criterios</label>
          <select name="cursos[${index}][meses][${mesIndex}][criterios][]" multiple>
            ${criterios.map(c => `<option value="${c._id}">${c.area.nombre}</option>`).join('')}
          </select>
          </div>`;

        // Observaciones
        htmlCompleto += `
          <div class="componente" data-componente="observaciones" style="display:none">
            <label>Observaciones</label>
            <textarea name="cursos[${index}][meses][${mesIndex}][observaciones]" rows="3" style="width:100%;"></textarea>
          </div>
        `;

       // Propostitos
        htmlCompleto += `
          <div class="componente" data-componente="propositos" style="display:none"> 
          <label>Propositos</label>
          <select name="cursos[${index}][meses][${mesIndex}][propositos][]" multiple>
            ${propositos.map(p => `<option value="${p._id}">${p.descripcion}</option>`).join('')}
          </select>
          </div>`;
        htmlCompleto += `<hr>`;
      }
      
      // Inicializar visibilidad seg√∫n los checkboxes
      cursoDiv.querySelectorAll(".comp-toggle").forEach(chk => chk.dispatchEvent(new Event("change")));

      mesesDiv.innerHTML = htmlCompleto;

    } catch (error) {
      console.error("Error generando contenidos:", error);
    } finally {
      ocultarLoader();
    }

    // --------------------------
    // 3Ô∏è‚É£ Listener de botones toggle
    cursoDiv.querySelectorAll(".comp-toggle").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const boton = e.currentTarget;
        const id = boton.dataset.componente;
        const activo = boton.dataset.activo === "true";

        // Alternar estado
        boton.dataset.activo = !activo;
        boton.classList.toggle("btn-primary", !activo);
        boton.classList.toggle("btn-outline-primary", activo);

        // Mostrar u ocultar todos los bloques de ese tipo
        cursoDiv.querySelectorAll(`.componente[data-componente="${id}"]`).forEach(div => {
          div.style.display = !activo ? "" : "none";
        });
      });
    });

    // Inicializar visibilidad seg√∫n los checkboxes
    cursoDiv.querySelectorAll(".comp-toggle").forEach(chk => chk.dispatchEvent(new Event("change")));

  }
  
</script>